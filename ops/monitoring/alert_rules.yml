groups:
  - name: easypan_alerts
    rules:
      - alert: HighAPILatency
        expr: histogram_quantile(0.95, sum(rate(http_server_requests_seconds_bucket[5m])) by (le)) > 2
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High API Latency Detected"
          description: "95th percentile latency is {{ $value }}s, exceeding 2s threshold"

      - alert: HighErrorRate
        expr: sum(rate(http_server_requests_seconds_count{status=~"5.."}[5m])) / sum(rate(http_server_requests_seconds_count[5m])) > 0.05
        for: 5m
        labels:
          severity: critical
        annotations:
          summary: "High Error Rate"
          description: "Error rate is {{ $value | humanizePercentage }}, exceeding 5% threshold"

      - alert: LowCacheHitRate
        expr: easypan_cache_hit_rate < 0.7
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Low Cache Hit Rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}, below 70% threshold"

      - alert: HighDatabaseConnections
        expr: hikaricp_connections_active / hikaricp_connections_max > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Database Connection Usage"
          description: "Database connection pool usage is {{ $value | humanizePercentage }}"

      - alert: DatabaseConnectionPoolExhausted
        expr: hikaricp_connections_active / hikaricp_connections_max > 0.95
        for: 2m
        labels:
          severity: critical
        annotations:
          summary: "Database Connection Pool Nearly Exhausted"
          description: "Connection pool usage is {{ $value | humanizePercentage }}, immediate action required"

      - alert: HighMemoryUsage
        expr: (jvm_memory_used_bytes{area="heap"} / jvm_memory_max_bytes{area="heap"}) > 0.85
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "High JVM Heap Memory Usage"
          description: "JVM heap usage is {{ $value | humanizePercentage }}"

      - alert: HighCPULoad
        expr: system_cpu_usage > 0.8
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High CPU Usage"
          description: "CPU usage is {{ $value | humanizePercentage }}"

      - alert: FileUploadFailures
        expr: sum(rate(easypan_file_upload_errors_total[5m])) > 5
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High File Upload Failure Rate"
          description: "{{ $value }} upload failures per second"

      - alert: SlowDatabaseQuery
        expr: histogram_quantile(0.95, sum(rate(spring_data_repository_invocations_seconds_bucket[5m])) by (le)) > 1
        for: 10m
        labels:
          severity: warning
        annotations:
          summary: "Slow Database Queries Detected"
          description: "95th percentile query time is {{ $value }}s"

      - alert: RedisConnectionFailure
        expr: up{job="redis"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "Redis Connection Failed"
          description: "Cannot connect to Redis instance"

      - alert: PostgreSQLDown
        expr: up{job="postgres"} == 0
        for: 1m
        labels:
          severity: critical
        annotations:
          summary: "PostgreSQL is Down"
          description: "Cannot connect to PostgreSQL instance"

      - alert: VirtualThreadStarvation
        expr: jdk_virtual_thread_started_count - jdk_virtual_thread_terminated_count > 10000
        for: 5m
        labels:
          severity: warning
        annotations:
          summary: "High Virtual Thread Count"
          description: "{{ $value }} active virtual threads, possible thread starvation"
