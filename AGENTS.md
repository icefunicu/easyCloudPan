# EasyCloudPan 开发纲领 (AGENTS.md)

> **文档版本**: v2.0  
> **最后更新**: 2026-02-13  
> **适用范围**: 前端、后端、数据库、运维、测试

本文档是 EasyCloudPan 项目的核心开发纲领，通过本文档可以快速了解项目全貌并进行开发。

---

## 目录

1. [项目概览](#1-项目概览)
2. [技术栈](#2-技术栈)
3. [项目架构](#3-项目架构)
4. [数据库设计](#4-数据库设计)
5. [核心业务逻辑](#5-核心业务逻辑)
6. [编码规约](#6-编码规约)
7. [性能优化规范](#7-性能优化规范)
8. [安全编码规范](#8-安全编码规范)
9. [监控和日志规范](#9-监控和日志规范)
10. [测试规范](#10-测试规范)
11. [部署和运维规范](#11-部署和运维规范)
12. [开发工作流](#12-开发工作流)

---

## 1. 项目概览

### 1.1 项目简介

EasyCloudPan 是一个前后端分离的企业级网盘系统，支持文件上传、管理、分享、回收站等核心功能，具备高性能、高安全性和高可用性。

### 1.2 核心功能

| 功能模块 | 功能描述 | 技术亮点 |
|---------|---------|---------|
| 用户认证 | 邮箱注册/登录、QQ 登录、JWT 双 Token 认证 | Token 黑名单、滑动刷新 |
| 文件管理 | 上传、下载、删除、重命名、移动、复制 | 分片上传、秒传、断点续传 |
| 文件分享 | 创建分享链接、密码保护、过期时间 | 访问日志、次数限制 |
| 回收站 | 文件恢复、彻底删除、自动清理 | 定时任务、批量操作 |
| 文件预览 | 图片、PDF、视频、音频、Office 文档 | 流式传输、转码 |
| 管理后台 | 用户管理、文件管理、系统设置 | 权限控制、审计日志 |
| 多租户 | 租户隔离、配额管理 | 租户上下文、数据隔离 |
| 监控告警 | 性能监控、业务指标、告警通知 | Prometheus + Grafana |

### 1.3 技术亮点

- **虚拟线程**: 基于 Java 21 虚拟线程，支持高并发场景（10000+ 并发）
- **多级缓存**: Caffeine 本地缓存 + Redis 分布式缓存，命中率 > 90%
- **秒传技术**: 基于 MD5 的文件去重，节省存储空间和上传时间
- **零拷贝**: NIO FileChannel.transferTo() 实现文件合并，降低内存占用
- **属性测试**: 使用 jqwik 进行属性测试，提高代码质量
- **结构化日志**: JSON 格式日志，支持 ELK 集成，敏感信息自动脱敏
- **安全加固**: JWT 双 Token、Token 黑名单、文件类型校验、配置加密

---

## 2. 技术栈

### 2.1 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **JDK** | 21+ | 运行环境（必须支持 Virtual Threads） |
| **Spring Boot** | 3.2.12 | 应用框架 |
| **MyBatis-Plus** | 3.5.9 | ORM 框架 |
| **MySQL** | 8.0+ | 关系型数据库 |
| **Redis** | 7.0+ | 缓存、分布式锁 |
| **Caffeine** | 3.1.8 | 本地缓存 |
| **JWT** | 0.12.6 | 认证授权 |
| **Flyway** | 10.21.0 | 数据库版本管理 |
| **Lombok** | 1.18.36 | 代码简化 |
| **Jasypt** | 3.0.5 | 配置加密 |
| **jqwik** | 1.9.2 | 属性测试框架 |
| **Micrometer** | 1.12.0 | 监控指标 |

### 2.2 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| **Vue** | 3.4+ | 前端框架 |
| **Element Plus** | 2.8+ | UI 组件库 |
| **Vite** | 5.4+ | 构建工具 |
| **Pinia** | 2.2+ | 状态管理 |
| **Axios** | 1.7+ | HTTP 客户端 |
| **SparkMD5** | 3.0+ | 文件 MD5 计算 |
| **Video.js** | 8.18+ | 视频播放器 |

### 2.3 开发工具

| 工具 | 用途 |
|------|------|
| **IntelliJ IDEA** | Java 开发 IDE |
| **VS Code** | 前端开发 IDE |
| **Docker** | 容器化部署 |
| **Git** | 版本控制 |
| **Postman** | API 测试 |
| **JMeter** | 性能测试 |

---

## 3. 项目架构

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         用户层                               │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐   │
│  │ Web 浏览器│  │ 移动端 APP│  │ 桌面客户端│  │  第三方   │   │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘   │
└─────────────────────────────────────────────────────────────┘
                            ↓ HTTPS
┌─────────────────────────────────────────────────────────────┐
│                      接入层 (Nginx)                          │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │ 负载均衡    │  │ SSL 终止   │  │ 静态资源   │           │
│  └────────────┘  └────────────┘  └────────────┘           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      应用层 (Spring Boot)                    │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Controller 层 (10个控制器)                          │  │
│  │  - AccountController, FileController, ShareController │  │
│  │  - AdminController, RecycleController, etc.          │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  AOP 层 (4个切面)                                    │  │
│  │  - GlobalExceptionHandler, VerifyParamAspect         │  │
│  │  - TenantContextAspect, LoggingAspect                │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Service 层 (20+服务)                                │  │
│  │  - UserInfoService, FileInfoService, FileShareService│  │
│  │  - EmailCodeService, TenantService, etc.             │  │
│  └──────────────────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────────────────┐  │
│  │  Component 层 (9个组件)                              │  │
│  │  - RedisComponent, FileComponent, EmailComponent     │  │
│  │  - TenantContextHolder, etc.                         │  │
│  └──────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      缓存层 (多级缓存)                        │
│  ┌────────────┐              ┌────────────┐                │
│  │ Caffeine   │ ←─ L1 ────→ │   Redis    │                │
│  │ 本地缓存    │              │ 分布式缓存  │                │
│  └────────────┘              └────────────┘                │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      数据层                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │   MySQL    │  │ 文件存储    │  │   Redis    │           │
│  │ 主从复制    │  │ 本地/OSS   │  │ 消息队列   │           │
│  └────────────┘  └────────────┘  └────────────┘           │
└─────────────────────────────────────────────────────────────┘
                            ↓
┌─────────────────────────────────────────────────────────────┐
│                      监控层                                  │
│  ┌────────────┐  ┌────────────┐  ┌────────────┐           │
│  │ Prometheus │  │  Grafana   │  │    ELK     │           │
│  │ 指标采集    │  │ 可视化监控  │  │ 日志分析   │           │
│  └────────────┘  └────────────┘  └────────────┘           │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 后端模块结构

```
backend/
├── src/main/java/com/easypan/
│   ├── aspect/              # AOP 切面 (4个)
│   │   ├── GlobalExceptionHandler.java
│   │   ├── VerifyParamAspect.java
│   │   ├── TenantContextAspect.java
│   │   └── LoggingAspect.java
│   ├── component/           # 组件 (9个)
│   │   ├── RedisComponent.java
│   │   ├── FileComponent.java
│   │   ├── EmailComponent.java
│   │   ├── TenantContextHolder.java
│   │   └── ...
│   ├── config/              # 配置类 (14个)
│   │   ├── RedisConfig.java
│   │   ├── CacheConfig.java
│   │   ├── SecurityConfig.java
│   │   └── ...
│   ├── controller/          # 控制器 (10个)
│   │   ├── AccountController.java
│   │   ├── FileController.java
│   │   ├── ShareController.java
│   │   ├── AdminController.java
│   │   ├── RecycleController.java
│   │   └── ...
│   ├── entity/              # 实体类
│   │   ├── po/              # 持久化对象
│   │   ├── dto/             # 数据传输对象
│   │   ├── vo/              # 视图对象
│   │   └── query/           # 查询对象
│   ├── mapper/              # MyBatis Mapper (6个)
│   │   ├── UserInfoMapper.java
│   │   ├── FileInfoMapper.java
│   │   ├── FileShareMapper.java
│   │   └── ...
│   ├── service/             # 服务层 (20+)
│   │   ├── UserInfoService.java
│   │   ├── FileInfoService.java
│   │   ├── FileShareService.java
│   │   └── ...
│   └── utils/               # 工具类
└── src/main/resources/
    ├── application.yml
    ├── application-dev.yml
    ├── application-prod.yml
    └── mapper/              # MyBatis XML
```

### 3.3 前端模块结构

```
frontend/
├── src/
│   ├── views/               # 页面 (9个)
│   │   ├── Login.vue
│   │   ├── Main.vue
│   │   ├── Share.vue
│   │   ├── Admin.vue
│   │   └── ...
│   ├── components/          # 组件 (11个)
│   │   ├── FileList.vue
│   │   ├── Uploader.vue
│   │   ├── Navigation.vue
│   │   └── ...
│   ├── components/preview/  # 预览组件 (7个)
│   │   ├── PreviewImage.vue
│   │   ├── PreviewVideo.vue
│   │   ├── PreviewPdf.vue
│   │   └── ...
│   ├── api/                 # API 接口
│   ├── stores/              # Pinia 状态管理
│   ├── router/              # 路由配置
│   └── utils/               # 工具函数
└── public/
```

---

## 4. 数据库设计

### 4.1 核心表结构

#### 4.1.1 用户表 (user_info)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| user_id | VARCHAR(15) | 用户ID (主键) | PK |
| nick_name | VARCHAR(20) | 昵称 | - |
| email | VARCHAR(150) | 邮箱 | UK |
| qq_open_id | VARCHAR(35) | QQ OpenID | UK |
| qq_avatar | VARCHAR(150) | QQ 头像 | - |
| password | VARCHAR(32) | 密码 (MD5) | - |
| join_time | DATETIME | 注册时间 | - |
| last_login_time | DATETIME | 最后登录时间 | - |
| status | TINYINT | 状态 (0禁用 1启用) | IDX |
| use_space | BIGINT | 已用空间 (字节) | - |
| total_space | BIGINT | 总空间 (字节) | - |
| tenant_id | VARCHAR(32) | 租户ID | IDX |


#### 4.1.2 文件表 (file_info)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| file_id | VARCHAR(10) | 文件ID (主键) | PK |
| user_id | VARCHAR(15) | 用户ID | IDX |
| file_md5 | VARCHAR(32) | 文件MD5 | IDX |
| file_pid | VARCHAR(10) | 父目录ID | IDX |
| file_size | BIGINT | 文件大小 | - |
| file_name | VARCHAR(200) | 文件名 | - |
| file_cover | VARCHAR(150) | 封面 | - |
| file_path | VARCHAR(100) | 文件路径 | - |
| create_time | DATETIME | 创建时间 | IDX |
| last_update_time | DATETIME | 最后更新时间 | - |
| folder_type | TINYINT | 文件夹类型 (0文件 1目录) | IDX |
| file_category | TINYINT | 文件分类 (1视频 2音频 3图片 4文档 5其他) | IDX |
| file_type | TINYINT | 文件类型 (详细分类) | - |
| status | TINYINT | 状态 (0转码中 1转码失败 2正常) | IDX |
| recovery_time | DATETIME | 回收时间 | IDX |
| del_flag | TINYINT | 删除标记 (0正常 1回收站 2已删除) | IDX |
| tenant_id | VARCHAR(32) | 租户ID | IDX |

#### 4.1.3 分享表 (file_share)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| share_id | VARCHAR(20) | 分享ID (主键) | PK |
| file_id | VARCHAR(10) | 文件ID | IDX |
| user_id | VARCHAR(15) | 用户ID | IDX |
| valid_type | TINYINT | 有效期类型 (0永久 1天 2周 3月) | - |
| expire_time | DATETIME | 过期时间 | IDX |
| share_time | DATETIME | 分享时间 | - |
| code | VARCHAR(5) | 提取码 | - |
| show_count | INT | 浏览次数 | - |
| tenant_id | VARCHAR(32) | 租户ID | IDX |

#### 4.1.4 邮箱验证码表 (email_code)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| email | VARCHAR(150) | 邮箱 (主键) | PK |
| code | VARCHAR(5) | 验证码 (主键) | PK |
| create_time | DATETIME | 创建时间 | - |
| status | TINYINT | 状态 (0未使用 1已使用) | - |

#### 4.1.5 租户表 (tenant_info)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| tenant_id | VARCHAR(32) | 租户ID (主键) | PK |
| tenant_name | VARCHAR(100) | 租户名称 | - |
| status | TINYINT | 状态 (0禁用 1启用) | IDX |
| total_space | BIGINT | 总空间配额 | - |
| used_space | BIGINT | 已用空间 | - |
| create_time | DATETIME | 创建时间 | - |

#### 4.1.6 分享访问日志表 (share_access_log)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | BIGINT | 主键 (自增) | PK |
| share_id | VARCHAR(20) | 分享ID | IDX |
| user_id | VARCHAR(15) | 访问用户ID | IDX |
| access_time | DATETIME | 访问时间 | IDX |
| ip_address | VARCHAR(50) | IP地址 | - |
| user_agent | VARCHAR(500) | User Agent | - |

#### 4.1.7 Web性能指标表 (web_vitals_metrics)

| 字段 | 类型 | 说明 | 索引 |
|------|------|------|------|
| id | BIGINT | 主键 (自增) | PK |
| metric_name | VARCHAR(50) | 指标名称 (LCP/FID/CLS) | IDX |
| metric_value | DECIMAL(10,2) | 指标值 | - |
| page_url | VARCHAR(500) | 页面URL | IDX |
| user_agent | VARCHAR(500) | User Agent | - |
| timestamp | DATETIME | 时间戳 | IDX |

### 4.2 索引设计原则

- **主键索引**: 所有表必须有主键，优先使用业务ID
- **唯一索引**: 邮箱、QQ OpenID 等唯一字段
- **普通索引**: 高频查询字段 (user_id, tenant_id, status, del_flag)
- **复合索引**: 多条件查询 (user_id + del_flag + folder_type)
- **时间索引**: 范围查询字段 (create_time, expire_time, recovery_time)

### 4.3 数据库迁移脚本

| 版本 | 文件名 | 说明 |
|------|--------|------|
| V1 | V1__init_schema.sql | 初始化数据库结构 |
| V2 | V2__add_tenant_support.sql | 添加多租户支持 |
| V3 | V3__add_share_access_log.sql | 添加分享访问日志表 |
| V4 | V4__add_web_vitals_metrics.sql | 添加Web性能指标表 |
| V5 | V5__add_file_indexes.sql | 优化文件表索引 |
| V6 | V6__add_user_indexes.sql | 优化用户表索引 |
| V7 | V7__add_share_indexes.sql | 优化分享表索引 |
| V8 | V8__add_tenant_space_fields.sql | 添加租户空间字段 |
| V9 | V9__optimize_query_performance.sql | 查询性能优化 |


---

## 5. 核心业务逻辑

### 5.1 用户认证流程

#### 5.1.1 JWT 双 Token 机制

- **Access Token**: 有效期 15 分钟，用于 API 访问
- **Refresh Token**: 有效期 7 天，用于刷新 Access Token
- **Token 黑名单**: 使用 Redis 存储已注销的 Token
- **滑动刷新**: Access Token 过期前 5 分钟自动刷新

#### 5.1.2 认证流程

1. 用户登录 → 验证邮箱/密码或 QQ OpenID
2. 生成 Access Token 和 Refresh Token
3. 将 Refresh Token 存入 Redis (key: refresh:token:{userId})
4. 返回双 Token 给客户端
5. 客户端每次请求携带 Access Token
6. 服务端验证 Token 有效性和黑名单
7. Token 过期前自动刷新或使用 Refresh Token 刷新

#### 5.1.3 注销流程

1. 客户端发起注销请求
2. 将 Access Token 和 Refresh Token 加入黑名单
3. 从 Redis 删除 Refresh Token
4. 清除客户端存储的 Token

### 5.2 文件上传流程

#### 5.2.1 分片上传

1. 前端计算文件 MD5 (使用 SparkMD5)
2. 调用秒传接口检查文件是否已存在
3. 如果存在则直接返回文件信息 (秒传)
4. 如果不存在则分片上传:
   - 将文件切分为 5MB 的分片
   - 并发上传分片到临时目录
   - 每个分片上传成功后记录进度
5. 所有分片上传完成后调用合并接口
6. 服务端使用零拷贝技术合并分片
7. 更新文件信息和用户空间

#### 5.2.2 秒传机制

- 基于文件 MD5 去重
- 检查数据库是否存在相同 MD5 的文件
- 如果存在则复用文件路径，只创建新的文件记录
- 节省存储空间和上传时间

#### 5.2.3 断点续传

- 前端记录已上传的分片索引
- 上传失败时从断点处继续上传
- 服务端校验分片完整性

### 5.3 文件分享流程

#### 5.3.1 创建分享

1. 用户选择文件创建分享
2. 设置有效期 (永久/1天/7天/30天)
3. 生成随机分享ID和提取码
4. 将分享信息存入数据库
5. 返回分享链接

#### 5.3.2 访问分享

1. 用户访问分享链接
2. 验证分享是否过期
3. 验证提取码 (如果设置)
4. 记录访问日志 (IP、User Agent、时间)
5. 增加浏览次数
6. 返回文件列表

#### 5.3.3 保存分享

1. 用户选择要保存的文件
2. 验证用户空间是否足够
3. 复制文件记录到用户目录
4. 更新用户已用空间

### 5.4 回收站流程

#### 5.4.1 删除文件

1. 将文件 del_flag 设置为 1 (回收站)
2. 记录 recovery_time (回收时间)
3. 不释放用户空间 (文件仍占用空间)

#### 5.4.2 恢复文件

1. 将文件 del_flag 设置为 0 (正常)
2. 清除 recovery_time
3. 检查目标目录是否存在同名文件

#### 5.4.3 彻底删除

1. 将文件 del_flag 设置为 2 (已删除)
2. 释放用户空间
3. 异步删除物理文件
4. 如果是最后一个引用则删除物理文件

#### 5.4.4 自动清理

- 定时任务每天凌晨执行
- 清理回收站中超过 10 天的文件
- 批量删除并释放空间

### 5.5 缓存策略

#### 5.5.1 多级缓存架构

```
请求 → Caffeine (L1) → Redis (L2) → MySQL (L3)
```

#### 5.5.2 缓存配置

| 缓存类型 | TTL | 最大条目 | 淘汰策略 |
|---------|-----|---------|---------|
| 用户信息 | 30分钟 | 10000 | LRU |
| 文件信息 | 15分钟 | 50000 | LRU |
| 分享信息 | 10分钟 | 5000 | LRU |
| 系统配置 | 1小时 | 1000 | LRU |

#### 5.5.3 缓存更新策略

- **Cache Aside**: 先更新数据库，再删除缓存
- **延迟双删**: 删除缓存 → 更新数据库 → 延迟 500ms → 再次删除缓存
- **缓存预热**: 应用启动时加载热点数据
- **缓存穿透**: 使用布隆过滤器或缓存空值
- **缓存雪崩**: 设置随机过期时间
- **缓存击穿**: 使用分布式锁

---

## 6. 编码规约

### 6.1 Lombok 使用规范

#### 6.1.1 推荐使用的注解

- `@Data`: 实体类 (PO/DTO/VO)
- `@Builder`: 构建器模式
- `@Slf4j`: 日志记录
- `@RequiredArgsConstructor`: 依赖注入 (final 字段)
- `@NoArgsConstructor`: 无参构造器 (JPA 实体)
- `@AllArgsConstructor`: 全参构造器

#### 6.1.2 禁止使用的注解

- `@ToString`: 可能导致循环引用和性能问题
- `@EqualsAndHashCode`: 可能导致意外的相等性判断


### 6.2 命名规范

#### 6.2.1 包命名

- 全部小写，使用点分隔
- 示例: `com.easypan.controller`, `com.easypan.service.impl`

#### 6.2.2 类命名

- 使用大驼峰 (PascalCase)
- Controller: `XxxController`
- Service: `XxxService` / `XxxServiceImpl`
- Mapper: `XxxMapper`
- Entity: `XxxPO` / `XxxDTO` / `XxxVO` / `XxxQuery`
- Config: `XxxConfig`
- Component: `XxxComponent`
- Utils: `XxxUtils`

#### 6.2.3 方法命名

- 使用小驼峰 (camelCase)
- 查询: `getXxx`, `findXxx`, `listXxx`, `queryXxx`
- 新增: `addXxx`, `createXxx`, `insertXxx`
- 修改: `updateXxx`, `modifyXxx`, `editXxx`
- 删除: `deleteXxx`, `removeXxx`
- 判断: `isXxx`, `hasXxx`, `canXxx`

#### 6.2.4 变量命名

- 使用小驼峰 (camelCase)
- 常量: 全大写，下划线分隔 (UPPER_SNAKE_CASE)
- 布尔变量: `isXxx`, `hasXxx`, `canXxx`

#### 6.2.5 数据库命名

- 表名: 小写，下划线分隔 (snake_case)
- 字段名: 小写，下划线分隔 (snake_case)
- 索引: `idx_字段名`, `uk_字段名` (唯一索引)

### 6.3 注释规范

#### 6.3.1 类注释

- 必须包含: 类的功能描述、作者、创建日期
- 可选: 版本号、修改记录

#### 6.3.2 方法注释

- 必须包含: 方法功能描述、参数说明、返回值说明
- 可选: 异常说明、示例代码

#### 6.3.3 字段注释

- 实体类字段必须添加注释
- 使用 `@Schema` 注解 (Swagger 文档)

### 6.4 数据库变更规范

#### 6.4.1 Flyway 迁移脚本规范

- 文件命名: `V{版本号}__{描述}.sql`
- 版本号: 递增整数 (V1, V2, V3...)
- 描述: 使用下划线分隔的英文描述
- 示例: `V10__add_user_avatar_field.sql`

#### 6.4.2 迁移脚本编写规范

- 每个脚本只做一件事
- 必须可重复执行 (幂等性)
- 使用 `IF NOT EXISTS` 检查
- 添加回滚说明注释
- 禁止修改已执行的脚本

#### 6.4.3 索引变更规范

- 添加索引前检查是否已存在
- 大表添加索引使用 `ALGORITHM=INPLACE`
- 删除索引前确认无业务使用

---

## 7. 性能优化规范

### 7.1 数据库优化

#### 7.1.1 查询优化

- 避免 `SELECT *`，只查询需要的字段
- 使用索引覆盖查询
- 避免在 WHERE 子句中使用函数
- 使用 LIMIT 限制返回行数
- 避免子查询，使用 JOIN 代替
- 使用 EXPLAIN 分析查询计划

#### 7.1.2 索引优化

- 高频查询字段添加索引
- 复合索引遵循最左前缀原则
- 避免过多索引 (影响写入性能)
- 定期分析索引使用情况
- 删除冗余索引

#### 7.1.3 分页优化

- 使用游标分页代替 OFFSET
- 深分页使用子查询优化
- 缓存总数，避免每次 COUNT

#### 7.1.4 批量操作

- 使用批量插入代替单条插入
- 批量更新使用 CASE WHEN
- 批量删除分批执行，避免锁表

### 7.2 缓存优化

#### 7.2.1 缓存设计原则

- 缓存热点数据 (80/20 原则)
- 设置合理的过期时间
- 使用多级缓存
- 缓存粒度适中 (不要太大也不要太小)

#### 7.2.2 缓存 Key 设计

- 使用命名空间: `模块:业务:ID`
- 示例: `user:info:123456`, `file:info:abc123`
- 避免 Key 冲突
- Key 长度适中 (不超过 100 字符)

#### 7.2.3 缓存更新策略

- 优先使用 Cache Aside 模式
- 关键业务使用延迟双删
- 避免缓存雪崩 (随机过期时间)
- 使用分布式锁防止缓存击穿

### 7.3 虚拟线程优化

#### 7.3.1 适用场景

- IO 密集型任务 (数据库查询、文件读写、网络请求)
- 高并发场景 (10000+ 并发)
- 长时间等待的任务

#### 7.3.2 不适用场景

- CPU 密集型任务 (加密、压缩、计算)
- 使用 ThreadLocal 的场景
- 需要线程池管理的场景

#### 7.3.3 使用规范

- 使用 `@Async` 注解标记异步方法
- 配置虚拟线程执行器
- 避免在虚拟线程中使用 synchronized
- 使用 ReentrantLock 代替 synchronized

### 7.4 文件处理优化

#### 7.4.1 文件上传优化

- 使用分片上传 (5MB/片)
- 并发上传分片 (最多 3 个并发)
- 使用零拷贝合并分片
- 异步处理文件转码

#### 7.4.2 文件下载优化

- 使用流式传输
- 支持断点续传 (Range 请求)
- 使用 Nginx X-Accel-Redirect
- 静态资源使用 CDN

#### 7.4.3 文件存储优化

- 使用 MD5 去重 (秒传)
- 图片压缩和缩略图
- 视频转码 (H.264)
- 冷数据归档到对象存储

### 7.5 前端优化

#### 7.5.1 资源优化

- 代码分割 (Code Splitting)
- 懒加载 (Lazy Loading)
- 图片懒加载
- 使用 WebP 格式
- 压缩 JS/CSS

#### 7.5.2 渲染优化

- 虚拟滚动 (大列表)
- 防抖和节流
- 使用 Web Worker
- 避免重排和重绘

#### 7.5.3 网络优化

- HTTP/2 多路复用
- 资源预加载 (Preload)
- 使用 CDN
- 开启 Gzip 压缩
- 使用浏览器缓存

---

## 8. 安全编码规范

### 8.1 认证授权

#### 8.1.1 密码安全

- 使用 MD5 + 盐值加密
- 密码长度 6-18 位
- 密码复杂度要求 (字母+数字)
- 登录失败次数限制 (5次/15分钟)
- 密码重置需要邮箱验证

#### 8.1.2 Token 安全

- 使用 JWT 双 Token 机制
- Access Token 短期有效 (15分钟)
- Refresh Token 长期有效 (7天)
- Token 黑名单机制
- Token 签名使用强密钥

#### 8.1.3 权限控制

- 基于角色的访问控制 (RBAC)
- 接口级权限校验
- 数据级权限校验 (租户隔离)
- 敏感操作二次验证


### 8.2 数据安全

#### 8.2.1 SQL 注入防护

- 使用参数化查询 (MyBatis #{})
- 禁止拼接 SQL
- 输入验证和过滤
- 使用 ORM 框架

#### 8.2.2 XSS 防护

- 输出转义 (HTML/JS/URL)
- 使用 Content-Security-Policy
- 禁止内联脚本
- 验证用户输入

#### 8.2.3 CSRF 防护

- 使用 CSRF Token
- 验证 Referer
- 使用 SameSite Cookie
- 敏感操作使用 POST

#### 8.2.4 敏感信息保护

- 配置文件加密 (Jasypt)
- 日志脱敏 (手机号、邮箱、身份证)
- 数据库字段加密 (密码、银行卡)
- HTTPS 传输

### 8.3 文件安全

#### 8.3.1 文件类型校验

- 白名单机制 (只允许特定类型)
- 文件头校验 (Magic Number)
- 文件扩展名校验
- MIME 类型校验

#### 8.3.2 文件大小限制

- 单文件大小限制 (默认 500MB)
- 用户总空间限制 (默认 50GB)
- 分片大小限制 (5MB)
- 并发上传限制 (3个)

#### 8.3.3 文件路径安全

- 禁止路径穿越 (../)
- 使用随机文件名
- 文件存储在非 Web 目录
- 下载时验证权限

### 8.4 分享安全

#### 8.4.1 分享链接安全

- 使用随机分享ID (20位)
- 提取码保护 (5位随机码)
- 设置过期时间
- 访问次数限制

#### 8.4.2 分享访问控制

- 记录访问日志 (IP、时间、User Agent)
- 异常访问检测 (频率限制)
- 恶意访问封禁
- 分享者可随时取消分享

---

## 9. 监控和日志规范

### 9.1 日志规范

#### 9.1.1 日志级别

| 级别 | 使用场景 | 示例 |
|------|---------|------|
| ERROR | 系统错误、异常 | 数据库连接失败、文件读写失败 |
| WARN | 警告信息、潜在问题 | 缓存未命中、配置缺失 |
| INFO | 关键业务操作 | 用户登录、文件上传、分享创建 |
| DEBUG | 调试信息 | 方法入参、SQL 语句、缓存命中 |
| TRACE | 详细跟踪信息 | 方法调用链、变量值 |

#### 9.1.2 日志格式

- 使用 JSON 格式 (便于 ELK 解析)
- 包含字段: timestamp, level, logger, thread, message, context
- 添加 traceId (分布式追踪)
- 添加 tenantId (多租户隔离)

#### 9.1.3 日志内容

- 记录关键业务操作 (谁、什么时间、做了什么、结果)
- 记录异常堆栈信息
- 敏感信息脱敏 (手机号、邮箱、密码)
- 避免记录大对象 (文件内容、大 JSON)

#### 9.1.4 日志输出

- 开发环境: 控制台 + 文件
- 生产环境: 文件 + ELK
- 日志文件按天滚动
- 保留 30 天日志
- 日志文件大小限制 (100MB)

### 9.2 监控指标

#### 9.2.1 系统指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| CPU 使用率 | 系统 CPU 使用率 | > 80% |
| 内存使用率 | 系统内存使用率 | > 85% |
| 磁盘使用率 | 磁盘空间使用率 | > 90% |
| 磁盘 IO | 磁盘读写速率 | > 80% |
| 网络流量 | 网络带宽使用率 | > 80% |

#### 9.2.2 应用指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| QPS | 每秒请求数 | > 10000 |
| 响应时间 | 接口平均响应时间 | > 1000ms |
| 错误率 | 接口错误率 | > 1% |
| 线程数 | 活跃线程数 | > 1000 |
| 连接池 | 数据库连接池使用率 | > 80% |

#### 9.2.3 业务指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| 注册用户数 | 每日新增注册用户 | < 10 |
| 活跃用户数 | 每日活跃用户数 | < 100 |
| 文件上传数 | 每日文件上传数 | < 50 |
| 文件下载数 | 每日文件下载数 | < 100 |
| 分享创建数 | 每日分享创建数 | < 20 |
| 存储空间 | 总存储空间使用率 | > 90% |

#### 9.2.4 缓存指标

| 指标 | 说明 | 告警阈值 |
|------|------|---------|
| 缓存命中率 | Caffeine + Redis 命中率 | < 80% |
| 缓存大小 | 缓存条目数 | > 100000 |
| 缓存驱逐率 | 缓存驱逐频率 | > 100/s |
| Redis 连接数 | Redis 连接池使用率 | > 80% |

### 9.3 告警规则

#### 9.3.1 告警级别

| 级别 | 说明 | 响应时间 | 通知方式 |
|------|------|---------|---------|
| P0 | 紧急 (服务不可用) | 5分钟 | 电话 + 短信 + 邮件 |
| P1 | 严重 (核心功能异常) | 15分钟 | 短信 + 邮件 |
| P2 | 警告 (性能下降) | 30分钟 | 邮件 |
| P3 | 提示 (潜在问题) | 1小时 | 邮件 |

#### 9.3.2 告警规则

- 服务不可用 (P0): 连续 3 次健康检查失败
- 接口错误率 > 5% (P1): 持续 5 分钟
- 响应时间 > 2000ms (P1): 持续 10 分钟
- CPU 使用率 > 90% (P1): 持续 5 分钟
- 内存使用率 > 90% (P1): 持续 5 分钟
- 磁盘使用率 > 95% (P1): 立即告警
- 缓存命中率 < 70% (P2): 持续 30 分钟

#### 9.3.3 告警收敛

- 相同告警 5 分钟内只发送一次
- 告警恢复后发送恢复通知
- 夜间告警 (00:00-08:00) 降级处理
- 节假日告警升级通知

---

## 10. 测试规范

### 10.1 单元测试

#### 10.1.1 测试覆盖率

- 核心业务代码覆盖率 > 80%
- Service 层覆盖率 > 90%
- Utils 工具类覆盖率 > 95%
- Controller 层覆盖率 > 70%

#### 10.1.2 测试框架

- JUnit 5: 单元测试框架
- Mockito: Mock 框架
- AssertJ: 断言库
- Spring Boot Test: 集成测试

#### 10.1.3 测试规范

- 测试类命名: `XxxTest`
- 测试方法命名: `testXxx_条件_预期结果`
- 使用 `@BeforeEach` 初始化测试数据
- 使用 `@AfterEach` 清理测试数据
- 测试方法独立，不依赖执行顺序
- 使用 Mock 隔离外部依赖


### 10.2 属性测试 (Property-Based Testing)

#### 10.2.1 适用场景

- 数据验证逻辑 (邮箱、手机号、文件名)
- 算法正确性 (加密、压缩、编码)
- 边界条件测试 (空值、极值、特殊字符)
- 幂等性测试 (重复操作结果一致)

#### 10.2.2 测试框架

- jqwik: Java 属性测试框架
- 支持自动生成测试数据
- 支持收缩 (Shrinking) 找到最小失败用例

#### 10.2.3 测试规范

- 测试方法使用 `@Property` 注解
- 使用 `@ForAll` 生成测试数据
- 定义属性不变量 (Invariant)
- 验证前置条件和后置条件
- 测试执行次数 > 1000 次

#### 10.2.4 测试示例场景

- 文件名验证: 任意合法文件名都能通过验证
- MD5 计算: 相同内容的文件 MD5 相同
- 分片合并: 合并后的文件与原文件一致
- 缓存一致性: 缓存数据与数据库数据一致
- 空间计算: 上传文件后空间增加，删除文件后空间减少

### 10.3 集成测试

#### 10.3.1 测试范围

- API 接口测试
- 数据库操作测试
- 缓存操作测试
- 文件操作测试
- 第三方服务集成测试

#### 10.3.2 测试环境

- 使用 H2 内存数据库或 Testcontainers
- 使用 Embedded Redis
- 使用 Mock Server 模拟第三方服务
- 测试数据隔离 (使用测试租户)

#### 10.3.3 测试规范

- 使用 `@SpringBootTest` 启动完整上下文
- 使用 `@Transactional` 自动回滚
- 使用 `@Sql` 初始化测试数据
- 测试完整业务流程
- 验证数据库状态变化

### 10.4 性能测试

#### 10.4.1 测试工具

- JMeter: 压力测试
- Gatling: 性能测试
- JMH: 微基准测试

#### 10.4.2 测试场景

- 并发上传测试 (1000 并发)
- 并发下载测试 (5000 并发)
- 分享访问测试 (10000 并发)
- 文件列表查询测试 (5000 并发)
- 缓存性能测试

#### 10.4.3 性能指标

- QPS: 每秒请求数 > 10000
- 响应时间: P95 < 500ms, P99 < 1000ms
- 错误率: < 0.1%
- CPU 使用率: < 70%
- 内存使用率: < 80%

---

## 11. 部署和运维规范

### 11.1 环境配置

#### 11.1.1 环境划分

| 环境 | 用途 | 配置 |
|------|------|------|
| dev | 开发环境 | 本地开发，使用 H2/MySQL |
| test | 测试环境 | 功能测试，使用独立数据库 |
| staging | 预发布环境 | 生产环境镜像，压力测试 |
| prod | 生产环境 | 正式环境，高可用配置 |

#### 11.1.2 配置管理

- 使用 Spring Profiles 管理多环境配置
- 敏感配置使用 Jasypt 加密
- 配置文件版本控制 (排除敏感信息)
- 使用配置中心 (Apollo/Nacos)

#### 11.1.3 环境变量

- 数据库连接信息
- Redis 连接信息
- JWT 密钥
- 文件存储路径
- 第三方服务密钥

### 11.2 部署方式

#### 11.2.1 Docker 部署

- 使用多阶段构建减小镜像体积
- 基础镜像: openjdk:21-jdk-slim
- 暴露端口: 8080 (应用), 9090 (监控)
- 挂载卷: 日志目录、文件存储目录
- 健康检查: /actuator/health

#### 11.2.2 Docker Compose 部署

- 一键启动所有服务
- 包含: 应用、MySQL、Redis、Nginx
- 使用网络隔离
- 使用卷持久化数据

#### 11.2.3 Kubernetes 部署

- 使用 Deployment 管理应用
- 使用 Service 暴露服务
- 使用 ConfigMap 管理配置
- 使用 Secret 管理敏感信息
- 使用 PVC 持久化存储
- 使用 HPA 自动扩缩容

### 11.3 发布流程

#### 11.3.1 发布前检查

- 代码审查通过
- 单元测试通过 (覆盖率 > 80%)
- 集成测试通过
- 性能测试通过
- 安全扫描通过
- 数据库迁移脚本准备

#### 11.3.2 发布步骤

1. 备份数据库
2. 执行数据库迁移脚本
3. 构建 Docker 镜像
4. 推送镜像到仓库
5. 更新 Kubernetes 配置
6. 滚动更新应用
7. 健康检查
8. 验证核心功能
9. 监控告警

#### 11.3.3 回滚策略

- 保留最近 3 个版本的镜像
- 发现问题立即回滚
- 回滚数据库 (如果需要)
- 通知相关人员
- 分析问题原因

### 11.4 故障排查

#### 11.4.1 日志查看

- 应用日志: `/var/log/easypan/app.log`
- 错误日志: `/var/log/easypan/error.log`
- 访问日志: `/var/log/nginx/access.log`
- 使用 ELK 查询日志
- 使用 traceId 追踪请求链路

#### 11.4.2 性能分析

- 使用 JProfiler 分析 CPU 和内存
- 使用 Arthas 在线诊断
- 使用 Prometheus + Grafana 查看监控指标
- 使用 Slow Query Log 分析慢查询
- 使用 Redis Monitor 分析缓存命中率

#### 11.4.3 常见问题

| 问题 | 原因 | 解决方案 |
|------|------|---------|
| 服务启动失败 | 端口占用、配置错误 | 检查端口、配置文件 |
| 接口超时 | 数据库慢查询、缓存失效 | 优化 SQL、检查缓存 |
| 内存溢出 | 内存泄漏、大对象 | 分析堆转储、优化代码 |
| CPU 100% | 死循环、大量计算 | 分析线程栈、优化算法 |
| 磁盘满 | 日志过多、文件过多 | 清理日志、归档文件 |

---

## 12. 开发工作流

### 12.1 Agent 协作流程

#### 12.1.1 需求分析阶段

1. 产品经理提出需求
2. 技术负责人评审需求
3. 拆分任务和估算工作量
4. 分配任务给开发人员

#### 12.1.2 开发阶段

1. 创建功能分支 (feature/xxx)
2. 编写代码和单元测试
3. 本地测试通过
4. 提交代码并推送到远程
5. 创建 Pull Request

#### 12.1.3 代码审查阶段

1. 自动化检查 (CI/CD)
   - 代码格式检查 (Checkstyle)
   - 单元测试 (JUnit)
   - 代码覆盖率 (JaCoCo)
   - 安全扫描 (SonarQube)
2. 人工审查
   - 代码规范
   - 业务逻辑
   - 性能优化
   - 安全问题
3. 审查通过后合并到主分支

#### 12.1.4 测试阶段

1. 部署到测试环境
2. 功能测试
3. 集成测试
4. 性能测试
5. 安全测试

#### 12.1.5 发布阶段

1. 部署到预发布环境
2. 验证核心功能
3. 部署到生产环境
4. 监控告警
5. 验证上线效果

### 12.2 分支管理

#### 12.2.1 分支策略

- `main`: 主分支，保护分支，只能通过 PR 合并
- `develop`: 开发分支，日常开发基于此分支
- `feature/xxx`: 功能分支，开发新功能
- `bugfix/xxx`: 修复分支，修复 Bug
- `hotfix/xxx`: 热修复分支，紧急修复生产问题
- `release/x.x.x`: 发布分支，准备发布

#### 12.2.2 分支命名规范

- 功能分支: `feature/用户认证模块`
- 修复分支: `bugfix/修复文件上传失败`
- 热修复分支: `hotfix/修复登录异常`
- 发布分支: `release/v1.0.0`

#### 12.2.3 提交规范

- 使用 Conventional Commits 规范
- 格式: `<type>(<scope>): <subject>`
- Type: feat, fix, docs, style, refactor, test, chore
- 示例: `feat(auth): 添加 QQ 登录功能`

### 12.3 代码审查

#### 12.3.1 审查清单

- [ ] 代码符合编码规范
- [ ] 业务逻辑正确
- [ ] 异常处理完善
- [ ] 日志记录合理
- [ ] 单元测试覆盖
- [ ] 性能优化
- [ ] 安全问题
- [ ] 注释清晰

#### 12.3.2 审查重点

- 核心业务逻辑
- 数据库操作 (SQL 注入、性能)
- 缓存使用 (一致性、过期时间)
- 异常处理 (是否捕获、是否记录)
- 并发安全 (线程安全、分布式锁)
- 资源释放 (连接、文件、流)

---

## 附录

### A. 常用命令

#### A.1 Maven 命令

```bash
# 编译
mvn clean compile

# 测试
mvn test

# 打包
mvn clean package -DskipTests

# 运行
mvn spring-boot:run
```

#### A.2 Docker 命令

```bash
# 构建镜像
docker build -t easypan:latest .

# 运行容器
docker run -d -p 8080:8080 easypan:latest

# 查看日志
docker logs -f <container_id>

# 进入容器
docker exec -it <container_id> /bin/bash
```

#### A.3 数据库命令

```bash
# 连接数据库
mysql -h localhost -u root -p

# 导出数据库
mysqldump -u root -p easypan > easypan.sql

# 导入数据库
mysql -u root -p easypan < easypan.sql
```

### B. 参考资料

- [Spring Boot 官方文档](https://spring.io/projects/spring-boot)
- [MyBatis-Plus 官方文档](https://baomidou.com/)
- [Vue 3 官方文档](https://vuejs.org/)
- [Element Plus 官方文档](https://element-plus.org/)
- [jqwik 用户指南](https://jqwik.net/docs/current/user-guide.html)
- [阿里巴巴 Java 开发手册](https://github.com/alibaba/p3c)

---

**文档结束**

> 本文档持续更新，如有问题请联系技术负责人。
